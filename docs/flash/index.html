<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>OAS-Man installer</title>
		<meta name="description" content="Easily allow users to install OAS-Man firmware on the web." />
		<meta name="viewport" content="width=device-width" />
		<meta name="color-scheme" content="dark light" />
		<style>
			body {
				font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, sans-serif;
				padding: 0;
				margin: 0;
				line-height: 1.4;
			}
			.content {
				max-width: 800px;
				margin: 0 auto;
				padding: 12px;
			}
			h2 {
				margin-top: 2em;
			}
			h3 {
				margin-top: 1.5em;
			}
			a {
				color: #03a9f4;
			}
			.invisible {
				visibility: hidden;
			}
			.hidden {
				display: none;
			}
			esp-web-install-button[install-unsupported] {
				visibility: inherit;
			}
			.content pre {
				max-width: 100%;
				overflow-y: scroll;
			}
			.footer {
				margin-top: 24px;
				border-top: 1px solid #ccc;
				padding-top: 24px;
				text-align: center;
			}
			.footer .initiative {
				font-style: italic;
				margin-top: 16px;
			}
			table {
				border-spacing: 0;
			}
			td {
				padding: 8px;
				border-bottom: 1px solid #ccc;
			}
			.radios li {
				list-style: none;
				line-height: 2em;
			}
			@media (prefers-color-scheme: dark) {
				body {
					background-color: #333;
					color: #fff;
				}
				a {
					color: #58a6ff;
				}
			}
			.grey-text {
				color: #A0A0A0;
			}
			.center {
				text-align: center;
			}
		</style>
		<script type="module" src="https://unpkg.com/esp-web-tools@10.1.1/dist/web/install-button.js?module"></script> <!-- Can change version number to 'latest' if I have issues in the future -->
		<script src="manifestgen.js"></script>
	</head>


	<script>
		// function getResult(filterBy, objList) {
		// 		return objList.filter(function (obj) {
		// 			return obj.assets.filter(function (item) {
		// 				console.log("Checking "+item.name+" for "+filterBy+"     "+ (item.name == filterBy));
		// 				return item.name == filterBy;
		// 			});
		// 		});
		// 	}

		var firmwareList = [];

		async function fetchFirmwareReleases() {

			try {
				const response = await fetch(`https://api.github.com/repos/gopro2027/ArduinoAirSuspensionController/releases`);
				const releases = await response.json();

				firmwareList = releases//getResult(binname+"_firmware.bin",releases)
				.map(release => ({
					name: release.name,
					tag: release.tag_name,
					date: new Date(release.created_at),
					body: release.body,
					assets: release.assets.map(asset => ({
						name: asset.name,
						size: asset.size,
						downloadUrl: asset.browser_download_url // PUBLIC URL!
					}))
				}));

				console.log(firmwareList);

				// displayFirmware(firmwareList);

				updateFirmwareRelatedDetails();
			} catch (error) {
				console.error('Error fetching releases:', error);
			}
		}

	// 	function displayFirmware(releases) {
	// 		const container = document.getElementById('firmware-list');
	// 		container.innerHTML = releases.map(release => `
	//     <div class="release">
	//       <h3>${release.name}</h3>
	//       <p><small>${release.date.toLocaleString()}</small></p>
	//       <p>${release.body}</p>
	//       <h4>Download:</h4>
	//       <ul>
	//         ${release.assets.map(asset => `
	//           <li>
	//             <a href="${asset.downloadUrl}" download>
	//               ${asset.name}
	//             </a>
	//             (${(asset.size / 1024).toFixed(2)} KB)
	//           </li>
	//         `).join('')}
	//       </ul>
	//     </div>
	//   `).join('');
	// 	}

		// Call on page load
		fetchFirmwareReleases();


		function getReleaseAsset(boardName, tag_name, subscript) {
			// for (release of firmwareList) {
			// 	for (asset of release.assets) {
			// 		if (asset.name === (chosenBoard + subscript)) {
			// 			return asset.downloadUrl;
			// 		}
			// 	}
			// }
			// updated to use this proxy URL because it has caching and it's the same one I use on the esp32's
			// I'm not sure what the limitations are for caching on this github api but maybe this will help. Either way, CORS is blocked on github releases direct links so we need a reverse proxy of some sort.
			return `http://githubreleasebinary-http-proxy.gopro2027.workers.dev/?url=https://github.com/gopro2027/ArduinoAirSuspensionController/releases/download/${tag_name}/${boardName}${subscript}`;
			// unfortunately have to use this reverse proxy service I set up on cloudflare instead of using the downloadUrl. Github releases has blocked CORS
			// This is the original proxy I used without caching
			//return `https://githubreleasesproxy.gopro2027.workers.dev/?tag_name=${tag_name}&file_name=${boardName}${subscript}`;
		}

		//reverse proxy code:

	// /**
	//  * Reverse proxy for GitHub releases
	//  * Usage: https://WORKERNAME.CLOUDFLAREUSERNAME.workers.dev/?user=${user}&repo=${repo}&tag_name=${tag_name}&file_name=${file_name}
	//  */
	// export default {
	// 	async fetch(request, env, ctx) {
	// 		const url = new URL(request.url);
	// 		const user = url.searchParams.get('user');
	// 		const repo = url.searchParams.get('repo');
	// 		const tag_name = url.searchParams.get('tag_name');
	// 		const file_name = url.searchParams.get('file_name');

	// 		if (!user || !repo || !tag_name || !file_name) {
	// 			return new Response('Missing required parameters: user or repo or tag_name or file_name', { status: 400, statusText: 'Bad Request' });
	// 		}

	// 		return new Response(
	// 			await (await fetch(`https://github.com/${user}/${repo}/releases/download/${tag_name}/${file_name}`)).arrayBuffer(),
	// 			{
	// 				headers: {
	// 					"Access-Control-Allow-Headers": request.headers.get("Access-Control-Request-Headers"),
	// 					"Access-Control-Allow-Methods": "GET,HEAD,POST,OPTIONS",
	// 					"Access-Control-Allow-Origin": "*",
	// 					"Access-Control-Max-Age": "300",
	// 					"content-type": "application/octet-stream",
	// 				}
	// 			}
	// 		);
	// 	},
	// };
	</script>


	<body>
		<div id="firmware-list"></div>
		<div class="content">
			<h1>OAS-Man installer</h1>
			<p>Select your product</p>

			<ul class="radios" id="firmwareRadioOptions">
				<h4>Manifold</h4>
				<li>
					<label><input type="radio" name="type" value="manifold_v4" /> Board V4 Manifold Firmwares</label>
				</li>
				<li>
					<label><input type="radio" name="type" value="manifold_v3" /> Board V3 Manifold Firmwares</label>
				</li>
				<li>
					<label><input type="radio" name="type" value="manifold_v2" /> Board V2 Manifold Firmwares (No acc wire functionality, will work for some v3 boards also)</label>
				</li>
				
				<hr>
				<h4>Controller</h4>
				<li>
					<label><input type="radio" name="type" value="controller_ws2p8" /> 2.8" Waveshare Controller Firmwares</label>
				</li>
				<li>
					<label><input type="radio" name="type" value="controller_ws2p8b" /> 2.8" B Model Waveshare Controller Firmwares</label>
				</li>
				<hr>
				<h4 class="grey-text">Legacy Devices</h4>
				<li>
					<label class="grey-text"><input type="radio" name="type" value="controller_cyd3p2" /> 3.2" CYD Capacitive Controller Firmwares</label>
				</li>
				<li>
					<label class="grey-text"><input type="radio" name="type" value="controller_cyd3p2_resistive" /> 3.2" CYD Resistive Controller Firmwares</label>
				</li>
			</ul>

			


			<div class="center">
				<select id="firmwareFilesSelect" hidden>
					<option value="NONE">NOTHING SELECTED</option>
				</select>
				<small id="versionnum" class="center">Version --</small>
				<p class="button-row" class="center">
					<esp-web-install-button class="invisible"></esp-web-install-button>
				</p>
			</div>

			<div class="footer"><a href="https://github.com/gopro2027/ArduinoAirSuspensionController">OAS-Man</a> &mdash; Installer powered by <a href="https://esphome.github.io/esp-web-tools/">ESP Web Tools</a>.</div>

			<div class="footer">
				<p><small>* firmware_no_acc: intended to be used on boards that do not utilize constant battery + acc input. Mostly only applies to manifold boards v2 and below.</small></p>
				<br>
				<p><small>Click <a href="https://github.com/gopro2027/ArduinoAirSuspensionController/tree/main/builds/Android">here to download the mobile app</a></small></p>
				<br>
				<p><small>❤️ oasman.dev</small></p>
				<br>
				<p><small>U,U,D,D,L,R,L,R,A,B</small></p>
			</div>
		</div>
		<script>

			
			let versionnum = "";
			let chosenBoard = "";
			let selectedreleaseName = "";

			function updateFirmwareRelatedDetails() {
				versionnum = firmwareList.length > 0 ? firmwareList[0].name : "Unknown";
				const element = document.getElementById("versionnum");
				element.textContent = "Latest Version: " + versionnum;
			}

			


			function setSelectedFile(tagName) {
				console.log(`Selected value: ${selectedreleaseName}`);


				const button = document.querySelector("esp-web-install-button");
				if (selectedreleaseName.length > 0) {
					var genurl = generate_manifest(chosenBoard, selectedreleaseName, getReleaseAsset(chosenBoard, tagName, "_bootloader.bin"), getReleaseAsset(chosenBoard, tagName, "_partitions.bin"), getReleaseAsset(chosenBoard, tagName, "_firmware.bin"));
					console.log(genurl);
					button.manifest = genurl;
					button.classList.remove("invisible");
				} else {
					button.classList.add("invisible");
				}
			}

			function loadFirmwareFiles(board_name) {
				chosenBoard = board_name;

				setSelectedFile("");
				selectedreleaseName = "";

				selectorObject = document.getElementById('firmwareFilesSelect');
				selectorObject.hidden = false;
				selectorObject.innerHTML = "";

				var hasSelected = false;

				for (release of firmwareList) {

					// check if a firmware for this board is in this release
					var found = false;
					for (asset of release.assets) {
						if (asset.name === (chosenBoard + "_firmware.bin")) {
							found = true;
						}
					}

					// append this release name if found
					if (found) {
						console.log(release.name);
						var opt = document.createElement('option');
						opt.value = release.tag;
						opt.innerHTML = release.name;
						selectorObject.appendChild(opt);

						// if this is the latest version, set it as selected
						if (release.name == versionnum || hasSelected == false) {
							console.log("selecting " + release.name);
							selectorObject.value = release.tag;
							selectedreleaseName = release.name;
							setSelectedFile(release.tag);
							hasSelected = true;
						}
					}
				}
			}

			document.getElementById('firmwareFilesSelect').addEventListener('change', (event) => {
				selectedreleaseName = event.target.innerHTML;
				setSelectedFile(event.target.value);
			});

			document.querySelectorAll('input[name="type"]').forEach((radio) =>
				radio.addEventListener("change", () => {
					loadFirmwareFiles(radio.value);
				})
			);

			
		</script>
	</body>
</html>
