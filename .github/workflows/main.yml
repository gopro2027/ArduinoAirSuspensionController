name: oasman-manifold-build

permissions:
  contents: write  # Allow the workflow to push changes

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
        mkdir -p bins/

    - name: Build PlatformIO manifold v2
      run: |
        buildname="manifold_v2"
        cd OASMan_ESP32
        pio run --target clean
        pio run
        find .pio/build/ -type f -name '*.bin' -exec sh -c 'cp -- "$1" "../bins/'"${buildname}"'_${1##*/}"' _ {} \;
      # find .pio/build/ -type f -name '*.bin' -exec bash -c 'for f; do cp -- "$f" "../bins/${buildname}_${f##*/}"; done' _ {} +
      # for f in OASMan_ESP32/.pio/build/**/*.bin; do cp -- "$f" "bins/manifold_v2_$f"; done
      # mkdir -p bins/v2/
      # cp OASMan_ESP32/.pio/build/**/*.bin bins/v2/ || true

    # - name: Build PlatformIO controller cyd3p2
    #   run: |
    #     buildname="controller_cyd3p2"
    #     cd Wireless_Controller
    #     pio run --target clean
    #     pio run -e esp32-2432S032C
    #     find .pio/build/ -type f -name '*.bin' -exec sh -c 'cp -- "$1" "../bins/'"${buildname}"'_${1##*/}"' _ {} \;

    
    #     mkdir -p bins/
      # for f in Wireless_Controller/.pio/build/**/*.bin; do cp -- "$f" "bins/controller_cyd3p2_$f"; done
      # mkdir -p bins/cyd3p2/
      # cp Wireless_Controller/.pio/build/**/*.bin bins/cyd3p2/ || true

    - name: Build PlatformIO controller ws2p8
      run: |
        buildname="controller_ws2p8"
        cd Wireless_Controller
        pio run --target clean
        pio run -e esp32-s3touchlcd2p8
        find .pio/build/ -type f -name '*.bin' -exec sh -c 'cp -- "$1" "../bins/'"${buildname}"'_${1##*/}"' _ {} \;
      # find .pio/build/ -type f -name '*.bin' -exec bash -c 'for f; do cp -- "$f" "../bins/${buildname}_${f##*/}"; done' _ {} +

    # - name: Upload build artifacts
    #   uses: actions/upload-artifact@v4
    #   if: success()
    #   with:
    #     name: firmware
    #     path: OASMan_ESP32/.pio/build/**/*.bin

    - name: Create Release
      if: success() && github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ github.run_number }}
        name: Build ${{ github.run_number }}
        body: |
          Automated build from commit ${{ github.sha }}
          
          **Commit:** ${{ github.event.head_commit.message }}
          **Date:** ${{ github.event.head_commit.timestamp }}
        files: bins/*.bin
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # - name: Prepare firmware for GitHub Pages
    #   if: success() && github.ref == 'refs/heads/main'
    #   run: |
    #     mkdir -p docs/firmware
    #     cp OASMan_ESP32/.pio/build/**/*.bin docs/firmware/ || true
        
    #     # Create an index JSON file with build info
    #     cat > docs/firmware/builds.json << EOF
    #     {
    #       "latest": {
    #         "commit": "${{ github.sha }}",
    #         "date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    #         "run_number": "${{ github.run_number }}",
    #         "files": $(ls docs/firmware/*.bin | jq -R -s -c 'split("\n")[:-1]')
    #       }
    #     }
    #     EOF

# okay this last step is failing because the github actions doesn't have permissions to bypass the branch protections to main yet
    # - name: Commit firmware to docs
    #   if: success() && github.ref == 'refs/heads/main'
    #   run: |
    #     git config user.name "GitHub Actions"
    #     git config user.email "actions@github.com"
    #     git add docs/firmware/
    #     git diff --staged --quiet || git commit -m "Update firmware build #${{ github.run_number }}"
    #     git push

